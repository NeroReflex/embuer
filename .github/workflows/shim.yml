name: Rust

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build-shim-amd64:
    runs-on: ubuntu-latest
    needs: build
    steps:
    - uses: actions/checkout@v4
    - name: Ensure Docker is available
      run: |
        if ! command -v docker >/dev/null 2>&1; then
          echo "docker is not installed or not in PATH" >&2
          exit 1
        fi
        docker --version

    - name: Build shim for amd64
      run: |
        echo "Building shim for amd64"
        ./scripts/build-shim-amd64.sh

  build-shim-aarch64:
    runs-on: ubuntu-latest
    architecture: arm64
    needs: build
    steps:
    - uses: actions/checkout@v4
    - name: Ensure Docker is available
      run: |
        if ! command -v docker >/dev/null 2>&1; then
          echo "docker is not installed or not in PATH" >&2
          exit 1
        fi
        docker --version

    - name: Build shim for aarch64
      run: |
        echo "Building shim for aarch64"
        ./scripts/build-shim-aarch64.sh
